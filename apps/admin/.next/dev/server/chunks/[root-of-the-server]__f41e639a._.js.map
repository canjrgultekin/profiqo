{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/source/canjrgultekin/profiqo/apps/admin/src/app/api/auth/register/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\ntype RegisterRequest = {\r\n  tenantName?: string;\r\n  tenantSlug?: string;\r\n  displayName?: string;\r\n  email?: string;\r\n  password?: string;\r\n  remember?: boolean;\r\n};\r\n\r\ntype BackendRegisterResponse = {\r\n  accessToken?: string;\r\n  token?: string;\r\n  jwt?: string;\r\n\r\n  refreshToken?: string;\r\n\r\n  expiresAtUtc?: string;\r\n  accessTokenExpiresAtUtc?: string;\r\n\r\n  tenantId?: string;\r\n  userId?: string;\r\n  roles?: string[] | number[];\r\n};\r\n\r\nconst ACCESS_COOKIE = \"profiqo_access_token\";\r\nconst REFRESH_COOKIE = \"profiqo_refresh_token\";\r\nconst TENANT_COOKIE = \"profiqo_tenant_id\";\r\nconst USER_COOKIE = \"profiqo_user_id\";\r\n\r\nfunction backendBaseUrl(): string {\r\n  return process.env.PROFIQO_BACKEND_URL?.trim() || \"http://localhost:5164\";\r\n}\r\n\r\nfunction parseExpiryDate(payload: BackendRegisterResponse): Date | null {\r\n  const raw = payload.expiresAtUtc || payload.accessTokenExpiresAtUtc;\r\n  if (!raw) return null;\r\n  const d = new Date(raw);\r\n  if (Number.isNaN(d.getTime())) return null;\r\n  return d;\r\n}\r\n\r\nasync function safeReadJson(res: Response): Promise<any> {\r\n  const text = await res.text();\r\n  if (!text) return null;\r\n  try {\r\n    return JSON.parse(text);\r\n  } catch {\r\n    return { message: text };\r\n  }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  const body = (await req.json().catch(() => null)) as RegisterRequest | null;\r\n\r\n  const tenantName = body?.tenantName?.trim() || \"\";\r\n  const tenantSlug = body?.tenantSlug?.trim() || \"\";\r\n  const displayName = body?.displayName?.trim() || \"\";\r\n  const email = body?.email?.trim() || \"\";\r\n  const password = body?.password || \"\";\r\n  const remember = Boolean(body?.remember);\r\n\r\n  if (!tenantName || !tenantSlug || !email || !password) {\r\n    return NextResponse.json(\r\n      { ok: false, message: \"Tenant adı, tenant slug, email ve şifre zorunlu.\" },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Backend’in beklediği net payload\r\n  const upstreamBody = {\r\n    tenantName,\r\n    tenantSlug,\r\n    ownerEmail: email,\r\n    ownerPassword: password,\r\n    ownerDisplayName: displayName || email.split(\"@\")[0],\r\n  };\r\n\r\n  const upstream = await fetch(`${backendBaseUrl()}/api/auth/register`, {\r\n    method: \"POST\",\r\n    headers: { \"content-type\": \"application/json\" },\r\n    cache: \"no-store\",\r\n    body: JSON.stringify(upstreamBody),\r\n  }).catch(() => null);\r\n\r\n  if (!upstream) {\r\n    return NextResponse.json(\r\n      { ok: false, message: \"Backend erişilemiyor (network).\" },\r\n      { status: 502 }\r\n    );\r\n  }\r\n\r\n  const payload = (await safeReadJson(upstream)) as BackendRegisterResponse | any;\r\n\r\n  if (!upstream.ok) {\r\n    // Backend validation detail’i varsa UI’da göster\r\n    const msg =\r\n      payload?.message ||\r\n      payload?.title ||\r\n      payload?.detail ||\r\n      \"Register başarısız.\";\r\n    return NextResponse.json(\r\n      { ok: false, message: msg, errors: payload?.errors ?? payload?.extensions?.errors ?? null },\r\n      { status: upstream.status }\r\n    );\r\n  }\r\n\r\n  const accessToken = payload?.accessToken || payload?.token || payload?.jwt;\r\n  const refreshToken = payload?.refreshToken;\r\n\r\n  const isProd = process.env.NODE_ENV === \"production\";\r\n  const res = NextResponse.json({\r\n    ok: true,\r\n    tenantId: payload?.tenantId ?? null,\r\n    userId: payload?.userId ?? null,\r\n    roles: payload?.roles ?? null,\r\n    hasTokens: Boolean(accessToken),\r\n  });\r\n\r\n  if (accessToken) {\r\n    const expiresAt = parseExpiryDate(payload);\r\n\r\n    if (expiresAt) {\r\n      res.cookies.set(ACCESS_COOKIE, accessToken, {\r\n        httpOnly: true,\r\n        secure: isProd,\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n        expires: expiresAt,\r\n      });\r\n    } else {\r\n      res.cookies.set(ACCESS_COOKIE, accessToken, {\r\n        httpOnly: true,\r\n        secure: isProd,\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n        maxAge: 60 * 60,\r\n      });\r\n    }\r\n\r\n    if (remember && refreshToken) {\r\n      res.cookies.set(REFRESH_COOKIE, refreshToken, {\r\n        httpOnly: true,\r\n        secure: isProd,\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n        maxAge: 30 * 24 * 60 * 60,\r\n      });\r\n    } else {\r\n      res.cookies.set(REFRESH_COOKIE, \"\", {\r\n        httpOnly: true,\r\n        secure: isProd,\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n        maxAge: 0,\r\n      });\r\n    }\r\n\r\n    if (payload?.tenantId) {\r\n      res.cookies.set(TENANT_COOKIE, payload.tenantId, {\r\n        httpOnly: true,\r\n        secure: isProd,\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n        maxAge: 30 * 24 * 60 * 60,\r\n      });\r\n    }\r\n\r\n    if (payload?.userId) {\r\n      res.cookies.set(USER_COOKIE, payload.userId, {\r\n        httpOnly: true,\r\n        secure: isProd,\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n        maxAge: 30 * 24 * 60 * 60,\r\n      });\r\n    }\r\n  }\r\n\r\n  return res;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}