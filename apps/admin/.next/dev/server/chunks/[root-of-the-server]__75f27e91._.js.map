{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/source/canjrgultekin/profiqo/apps/admin/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { cookies } from \"next/headers\";\r\n\r\ntype LoginRequest = {\r\n  tenantSlug?: string;\r\n  email?: string;\r\n  password?: string;\r\n  remember?: boolean;\r\n};\r\n\r\nconst ACCESS_COOKIE = \"profiqo_access_token\";\r\nconst REFRESH_COOKIE = \"profiqo_refresh_token\";\r\nconst TENANT_COOKIE = \"profiqo_tenant_id\";\r\nconst USER_COOKIE = \"profiqo_user_id\";\r\nconst ROLES_COOKIE = \"profiqo_roles\";\r\n\r\nfunction backendBaseUrl(): string {\r\n  return process.env.PROFIQO_BACKEND_URL?.trim() || \"http://localhost:5164\";\r\n}\r\n\r\nasync function safeReadJson(res: Response): Promise<any> {\r\n  const text = await res.text();\r\n  if (!text) return null;\r\n  try {\r\n    return JSON.parse(text);\r\n  } catch {\r\n    return { message: text };\r\n  }\r\n}\r\n\r\nfunction pickAccessToken(payload: any): string | null {\r\n  const t1 =\r\n    payload?.tokens?.accessToken ||\r\n    payload?.tokens?.token ||\r\n    payload?.accessToken ||\r\n    payload?.token ||\r\n    payload?.jwt;\r\n\r\n  const t2 =\r\n    payload?.Tokens?.AccessToken ||\r\n    payload?.Tokens?.Token ||\r\n    payload?.AccessToken ||\r\n    payload?.Token ||\r\n    payload?.Jwt;\r\n\r\n  return (t1 || t2 || null) as string | null;\r\n}\r\n\r\nfunction pickExpiresAt(payload: any): Date | null {\r\n  const raw =\r\n    payload?.tokens?.accessTokenExpiresAtUtc ||\r\n    payload?.accessTokenExpiresAtUtc ||\r\n    payload?.expiresAtUtc ||\r\n    payload?.Tokens?.AccessTokenExpiresAtUtc ||\r\n    payload?.AccessTokenExpiresAtUtc ||\r\n    payload?.ExpiresAtUtc;\r\n\r\n  if (!raw) return null;\r\n  const d = new Date(raw);\r\n  return Number.isNaN(d.getTime()) ? null : d;\r\n}\r\n\r\nfunction pickUserInfo(payload: any): { tenantId: string | null; userId: string | null; roles: any } {\r\n  const u = payload?.user || payload?.User || null;\r\n\r\n  const tenantId =\r\n    u?.tenantId ||\r\n    u?.TenantId ||\r\n    payload?.tenantId ||\r\n    payload?.TenantId ||\r\n    null;\r\n\r\n  const userId =\r\n    u?.userId ||\r\n    u?.UserId ||\r\n    payload?.userId ||\r\n    payload?.UserId ||\r\n    null;\r\n\r\n  const roles = u?.roles || u?.Roles || payload?.roles || payload?.Roles || null;\r\n\r\n  return { tenantId, userId, roles };\r\n}\r\n\r\n// Map numeric role codes -> names\r\nfunction roleNameFromCode(code: string): string | null {\r\n  switch (code) {\r\n    case \"1\": return \"Owner\";\r\n    case \"2\": return \"Admin\";\r\n    case \"3\": return \"Reporting\";\r\n    case \"4\": return \"Integration\";\r\n    default: return null;\r\n  }\r\n}\r\n\r\nfunction normalizeRolesToString(roles: any): string | null {\r\n  if (!roles) return null;\r\n\r\n  const out: string[] = [];\r\n\r\n  if (Array.isArray(roles)) {\r\n    for (const r of roles) {\r\n      const s = String(r).trim();\r\n      if (!s) continue;\r\n\r\n      // already a name?\r\n      if ([\"Owner\", \"Admin\", \"Reporting\", \"Integration\"].includes(s)) {\r\n        out.push(s);\r\n        continue;\r\n      }\r\n\r\n      // numeric?\r\n      const mapped = roleNameFromCode(s);\r\n      if (mapped) out.push(mapped);\r\n    }\r\n  } else {\r\n    const s = String(roles).trim();\r\n    if ([\"Owner\", \"Admin\", \"Reporting\", \"Integration\"].includes(s)) out.push(s);\r\n    else {\r\n      const mapped = roleNameFromCode(s);\r\n      if (mapped) out.push(mapped);\r\n    }\r\n  }\r\n\r\n  const distinct = Array.from(new Set(out));\r\n  return distinct.length ? distinct.join(\",\") : null;\r\n}\r\n\r\n// Try extract roles from JWT payload if backend didn't return roles.\r\n// This is only for UI gating; signature verification isn't required here.\r\nfunction tryGetRolesFromJwt(accessToken: string): string | null {\r\n  try {\r\n    const parts = accessToken.split(\".\");\r\n    if (parts.length < 2) return null;\r\n\r\n    const payloadB64 = parts[1]\r\n      .replace(/-/g, \"+\")\r\n      .replace(/_/g, \"/\")\r\n      .padEnd(Math.ceil(parts[1].length / 4) * 4, \"=\");\r\n\r\n    const json = Buffer.from(payloadB64, \"base64\").toString(\"utf8\");\r\n    const payload = JSON.parse(json);\r\n\r\n    // common claims patterns\r\n    const candidates =\r\n      payload?.roles ??\r\n      payload?.role ??\r\n      payload?.Roles ??\r\n      payload?.Role ??\r\n      payload?.[\"http://schemas.microsoft.com/ws/2008/06/identity/claims/role\"] ??\r\n      null;\r\n\r\n    return normalizeRolesToString(candidates);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  const body = (await req.json().catch(() => null)) as LoginRequest | null;\r\n\r\n  const tenantSlug = body?.tenantSlug?.trim() || \"\";\r\n  const email = body?.email?.trim() || \"\";\r\n  const password = body?.password || \"\";\r\n  const remember = Boolean(body?.remember);\r\n\r\n  if (!tenantSlug || !email || !password) {\r\n    return NextResponse.json(\r\n      { ok: false, message: \"Tenant slug, email ve şifre zorunlu.\" },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  const upstream = await fetch(`${backendBaseUrl()}/api/auth/login`, {\r\n    method: \"POST\",\r\n    headers: { \"content-type\": \"application/json\" },\r\n    cache: \"no-store\",\r\n    body: JSON.stringify({ tenantSlug, email, password }),\r\n  }).catch(() => null);\r\n\r\n  if (!upstream) {\r\n    return NextResponse.json(\r\n      { ok: false, message: \"Backend erişilemiyor (network).\" },\r\n      { status: 502 }\r\n    );\r\n  }\r\n\r\n  const payload = await safeReadJson(upstream);\r\n\r\n  if (!upstream.ok) {\r\n    const msg =\r\n      payload?.message ||\r\n      payload?.title ||\r\n      payload?.detail ||\r\n      \"Login başarısız.\";\r\n\r\n    return NextResponse.json(\r\n      { ok: false, message: msg, errors: payload?.errors ?? payload?.extensions?.errors ?? null },\r\n      { status: upstream.status }\r\n    );\r\n  }\r\n\r\n  const accessToken = pickAccessToken(payload);\r\n  if (!accessToken) {\r\n    return NextResponse.json(\r\n      { ok: false, message: \"Backend login response içinde access token yok.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  const expiresAt = pickExpiresAt(payload);\r\n  const { tenantId, userId, roles } = pickUserInfo(payload);\r\n\r\n  const isProd = process.env.NODE_ENV === \"production\";\r\n  const res = NextResponse.json({ ok: true, tenantId, userId, roles });\r\n\r\n  // Access token cookie\r\n  if (expiresAt) {\r\n    res.cookies.set(ACCESS_COOKIE, accessToken, {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      expires: expiresAt,\r\n    });\r\n  } else {\r\n    res.cookies.set(ACCESS_COOKIE, accessToken, {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 60 * 60,\r\n    });\r\n  }\r\n\r\n  // Tenant/User cookies\r\n  if (tenantId) {\r\n    res.cookies.set(TENANT_COOKIE, tenantId, {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 30 * 24 * 60 * 60,\r\n    });\r\n  }\r\n\r\n  if (userId) {\r\n    res.cookies.set(USER_COOKIE, userId, {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 30 * 24 * 60 * 60,\r\n    });\r\n  }\r\n\r\n  // Roles cookie for middleware RBAC\r\n  let rolesStr = normalizeRolesToString(roles);\r\n  if (!rolesStr) {\r\n    rolesStr = tryGetRolesFromJwt(accessToken);\r\n  }\r\n\r\n  if (rolesStr) {\r\n    res.cookies.set(ROLES_COOKIE, rolesStr, {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 30 * 24 * 60 * 60,\r\n    });\r\n  } else {\r\n    // clear to avoid stale RBAC\r\n    res.cookies.set(ROLES_COOKIE, \"\", {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 0,\r\n    });\r\n  }\r\n\r\n  // Refresh token handling (backend may not return; if remember false clear)\r\n  if (!remember) {\r\n    res.cookies.set(REFRESH_COOKIE, \"\", {\r\n      httpOnly: true,\r\n      secure: isProd,\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 0,\r\n    });\r\n  }\r\n\r\n  // keep Next 16 async cookies API happy\r\n  await cookies();\r\n\r\n  return res;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}