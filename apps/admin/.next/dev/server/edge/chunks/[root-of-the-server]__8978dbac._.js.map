{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\n\r\nconst ACCESS_COOKIE = \"profiqo_access_token\";\r\nconst ROLES_COOKIE = \"profiqo_roles\";\r\nconst TENANT_COOKIE = \"profiqo_tenant_id\";\r\n\r\nfunction isPublic(pathname: string): boolean {\r\n  if (pathname.startsWith(\"/auth\")) return true;\r\n  if (pathname.startsWith(\"/api\")) return true;\r\n  if (pathname.startsWith(\"/_next\")) return true;\r\n  if (pathname === \"/favicon.ico\") return true;\r\n  return false;\r\n}\r\n\r\nfunction mapRoleToken(s: string): string | null {\r\n  const t = s.trim();\r\n  if (!t) return null;\r\n  if ([\"Owner\", \"Admin\", \"Integration\", \"Reporting\"].includes(t)) return t;\r\n  if (t === \"1\") return \"Owner\";\r\n  if (t === \"2\") return \"Admin\";\r\n  if (t === \"3\") return \"Reporting\";\r\n  if (t === \"4\") return \"Integration\";\r\n  return null;\r\n}\r\n\r\nfunction parseRoles(raw: string | undefined): Set<string> {\r\n  const set = new Set<string>();\r\n  if (!raw) return set;\r\n\r\n  raw\r\n    .split(\",\")\r\n    .map((x) => mapRoleToken(x))\r\n    .filter((x): x is string => Boolean(x))\r\n    .forEach((x) => set.add(x));\r\n\r\n  return set;\r\n}\r\n\r\nfunction hasAnyRole(roles: Set<string>, allowed: string[]): boolean {\r\n  return allowed.some((r) => roles.has(r));\r\n}\r\n\r\n// Edge-safe base64url decode (no Buffer)\r\nfunction b64UrlDecode(input: string): string | null {\r\n  try {\r\n    const b64 = input.replace(/-/g, \"+\").replace(/_/g, \"/\");\r\n    const padded = b64.padEnd(Math.ceil(b64.length / 4) * 4, \"=\");\r\n    return atob(padded);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction isJwtExpired(token: string): boolean {\r\n  // token: header.payload.signature\r\n  const parts = token.split(\".\");\r\n  if (parts.length < 2) return false;\r\n\r\n  const json = b64UrlDecode(parts[1]);\r\n  if (!json) return false;\r\n\r\n  try {\r\n    const payload = JSON.parse(json);\r\n    const exp = payload?.exp;\r\n\r\n    // exp typically seconds\r\n    if (typeof exp === \"number\") {\r\n      const nowSec = Math.floor(Date.now() / 1000);\r\n      return exp <= nowSec;\r\n    }\r\n\r\n    return false;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction redirectToSignIn(req: NextRequest) {\r\n  const url = req.nextUrl.clone();\r\n  url.pathname = \"/auth/sign-in\";\r\n\r\n  const res = NextResponse.redirect(url);\r\n\r\n  // clear auth cookies immediately to prevent flash / loops\r\n  res.cookies.set(ACCESS_COOKIE, \"\", { path: \"/\", maxAge: 0 });\r\n  res.cookies.set(TENANT_COOKIE, \"\", { path: \"/\", maxAge: 0 });\r\n  res.cookies.set(ROLES_COOKIE, \"\", { path: \"/\", maxAge: 0 });\r\n\r\n  return res;\r\n}\r\n\r\nexport function middleware(req: NextRequest) {\r\n  const { pathname } = req.nextUrl;\r\n\r\n  if (isPublic(pathname)) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  const token = req.cookies.get(ACCESS_COOKIE)?.value;\r\n\r\n  // No token => no render, immediate redirect\r\n  if (!token) {\r\n    return redirectToSignIn(req);\r\n  }\r\n\r\n  // Token exists but expired => clear + redirect BEFORE any page render\r\n  if (isJwtExpired(token)) {\r\n    return redirectToSignIn(req);\r\n  }\r\n\r\n  const roles = parseRoles(req.cookies.get(ROLES_COOKIE)?.value);\r\n\r\n  // Owner-only\r\n  if (pathname.startsWith(\"/settings/users\")) {\r\n    if (!hasAnyRole(roles, [\"Owner\"])) {\r\n      const url = req.nextUrl.clone();\r\n      url.pathname = \"/403\";\r\n      return NextResponse.redirect(url);\r\n    }\r\n  }\r\n\r\n  // Integrations\r\n  if (pathname.startsWith(\"/integrations\")) {\r\n    if (!hasAnyRole(roles, [\"Owner\", \"Admin\", \"Integration\"])) {\r\n      const url = req.nextUrl.clone();\r\n      url.pathname = \"/403\";\r\n      return NextResponse.redirect(url);\r\n    }\r\n  }\r\n\r\n  // Reporting\r\n  if (pathname.startsWith(\"/customers\") || pathname.startsWith(\"/orders\") || pathname.startsWith(\"/reports\")) {\r\n    if (!hasAnyRole(roles, [\"Owner\", \"Admin\", \"Integration\", \"Reporting\"])) {\r\n      const url = req.nextUrl.clone();\r\n      url.pathname = \"/403\";\r\n      return NextResponse.redirect(url);\r\n    }\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!_next/static|_next/image|favicon.ico).*)\"],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}