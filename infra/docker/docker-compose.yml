name: profiqo

networks:
  profiqo-net:
    driver: bridge

volumes:
  profiqo_pg_data:
  profiqo_pgadmin_data:
  profiqo_redis_data:
  profiqo_rabbitmq_data:
  profiqo_kafka_data:
  profiqo_prometheus_data:
  profiqo_grafana_data:
  profiqo_elasticsearch_data:

services:
  postgres:
    image: postgres:18.1
    container_name: profiqo-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${TZ}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - profiqo_pg_data:/var/lib/postgresql
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - profiqo-net

  pgadmin:
    image: dpage/pgadmin4:9.11
    container_name: profiqo-pgadmin
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
      TZ: ${TZ}
    ports:
      - "${PGADMIN_PORT}:80"
    volumes:
      - profiqo_pgadmin_data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
    networks:
      - profiqo-net

  redis:
    image: redis:8.4.0
    container_name: profiqo-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - profiqo_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - profiqo-net

  rabbitmq:
    image: rabbitmq:4.2.3-management-alpine
    container_name: profiqo-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_DEFAULT_VHOST}
      TZ: ${TZ}
    ports:
      - "${RABBITMQ_AMQP_PORT}:5672"
      - "${RABBITMQ_HTTP_PORT}:15672"
    volumes:
      - profiqo_rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - profiqo-net

  kafka:
    image: apache/kafka:4.1.1
    container_name: profiqo-kafka
    restart: unless-stopped
    ports:
      - "${KAFKA_PORT}:9092"
    environment:
      # Single-node KRaft + dual listener:
      # - host apps connect: localhost:9092
      # - docker network apps connect: kafka:19092
      KAFKA_NODE_ID: ${KAFKA_NODE_ID}
      KAFKA_PROCESS_ROLES: "broker,controller"

      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"

      KAFKA_LISTENERS: "PLAINTEXT://:19092,PLAINTEXT_HOST://:9092,CONTROLLER://:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:19092,PLAINTEXT_HOST://localhost:9092"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"

      KAFKA_LOG_DIRS: "/var/lib/kafka/data"

      # Single-node safe defaults
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
      KAFKA_NUM_PARTITIONS: "1"
    volumes:
      - profiqo_kafka_data:/var/lib/kafka/data
    networks:
      - profiqo-net

  kafka-ui:
    image: provectuslabs/kafka-ui:v0.7.2
    container_name: profiqo-kafka-ui
    restart: unless-stopped
    depends_on:
      - kafka
    environment:
      DYNAMIC_CONFIG_ENABLED: "true"
      KAFKA_CLUSTERS_0_NAME: "profiqo-local"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka:19092"
    ports:
      - "${KAFKA_UI_PORT}:8080"
    networks:
      - profiqo-net

  zipkin:
    image: openzipkin/zipkin:3.3.1
    container_name: profiqo-zipkin
    restart: unless-stopped
    ports:
      - "${ZIPKIN_PORT}:9411"
    networks:
      - profiqo-net

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.144.0
    container_name: profiqo-otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./otel-collector/otel-collector.yml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      - "${OTEL_COLLECTOR_GRPC_PORT}:4317"
      - "${OTEL_COLLECTOR_HTTP_PORT}:4318"
      - "${OTEL_COLLECTOR_PROM_PORT}:9464"
    depends_on:
      - zipkin
    networks:
      - profiqo-net

  prometheus:
    image: prom/prometheus:v3.5.1
    container_name: profiqo-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - profiqo_prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT}:9090"
    depends_on:
      - otel-collector
    networks:
      - profiqo-net

  grafana:
    image: grafana/grafana:12.0.8
    container_name: profiqo-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
      TZ: ${TZ}
    volumes:
      - profiqo_grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "${GRAFANA_PORT}:3000"
    depends_on:
      - prometheus
      - zipkin
    networks:
      - profiqo-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: profiqo-elasticsearch
    restart: unless-stopped
    environment:
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
      - "xpack.security.http.ssl.enabled=false"
      - "xpack.security.transport.ssl.enabled=false"
      - "bootstrap.memory_lock=true"
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - profiqo_elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "${ELASTICSEARCH_PORT}:9200"
    networks:
      - profiqo-net

  kibana:
    image: docker.elastic.co/kibana/kibana:${ELASTIC_VERSION}
    container_name: profiqo-kibana
    restart: unless-stopped
    depends_on:
      - elasticsearch
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
      XPACK_SECURITY_ENABLED: "false"
      TZ: ${TZ}
    ports:
      - "${KIBANA_PORT}:5601"
    networks:
      - profiqo-net

  logstash:
    image: docker.elastic.co/logstash/logstash:${ELASTIC_VERSION}
    container_name: profiqo-logstash
    restart: unless-stopped
    depends_on:
      - elasticsearch
    environment:
      XPACK_MONITORING_ENABLED: "false"
      TZ: ${TZ}
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
    ports:
      - "${LOGSTASH_HTTP_PORT}:8080"
      - "${LOGSTASH_MONITOR_PORT}:9600"
    networks:
      - profiqo-net
