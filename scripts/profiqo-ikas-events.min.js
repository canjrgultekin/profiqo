!function () {
  "use strict";

  var e = {
    DEFAULT_API_BASE: "http://localhost:5164",
    EVENTS_ENDPOINT: "/api/v1/events/storefront",
    CONFIG_ENDPOINT: "/api/v1/events/storefront/config",

    DEVICE_ID_COOKIE: "_pfq_did",
    SESSION_ID_KEY: "_pfq_sid",
    CUSTOMER_KEY: "_pfq_cust",
    TENANT_KEY: "_pfq_tenant",

    COOKIE_MAX_AGE_DAYS: 730,
    SESSION_TIMEOUT_MS: 18e5,

    BATCH_INTERVAL_MS: 2e3,
    MAX_QUEUE_SIZE: 20,
    MAX_RETRIES: 2,
    RETRY_DELAY_MS: 1e3,

    SUBSCRIBE_ID: "profiqo_storefront_tracker_v2",
    POLL_INTERVAL_MS: 200,
    MAX_POLLS: 50,

    SUPPORTED_EVENTS: {
      ADDTOCART: "ADD_TO_CART",
      REMOVEFROMCART: "REMOVE_FROM_CART",
      COMPLETECHECKOUT: "COMPLETE_CHECKOUT",
      ADDTOWISHLIST: "ADD_TO_WISHLIST"
    },

    IKAS_STRING_EVENTS: {
      addtocart: "ADD_TO_CART",
      removefromcart: "REMOVE_FROM_CART",
      completecheckout: "COMPLETE_CHECKOUT",
      addtowishlist: "ADD_TO_WISHLIST"
    },

    IKAS_EVENT_TYPES: {
      1: "PAGE_VIEW",
      2: "PRODUCT_VIEW",
      3: "REMOVE_FROM_CART",
      4: "ADD_TO_CART",
      5: "BEGIN_CHECKOUT",
      6: "COMPLETE_CHECKOUT",
      7: "SEARCH",
      8: "ADD_TO_WISHLIST",
      12: "COMPLETE_CHECKOUT",
      16: "ADD_TO_WISHLIST"
    }
  };

  var t = document.currentScript;
  var n = null;
  var r = e.DEFAULT_API_BASE;

  if (t && t.src) {
    try {
      var a = new URLSearchParams(t.src.split("?")[1] || "");
      n = a.get("apiKey") || a.get("publicApiKey") || a.get("key");

      var i = a.get("endpoint") || a.get("url");
      if (i) r = i.replace(/\/+$/, "");
    } catch (ex) {
      var u = t.src.match(/[?&]apiKey=([^&]+)/);
      if (u) n = decodeURIComponent(u[1]);
    }
  }

  if (!n) {
    console.warn("[Profiqo] apiKey bulunamadı. Script src'ye ?apiKey=YOUR_KEY ekleyin.");
    return;
  }

  var l = null;
  var o = null;
  l = A();

  var s = null;
  try {
    var d = sessionStorage.getItem(e.TENANT_KEY);
    if (d) s = JSON.parse(d);
  } catch (ex) { }

  var c = r + e.CONFIG_ENDPOINT + "?apiKey=" + encodeURIComponent(n);
  if (typeof fetch === "function") {
    fetch(c, { method: "GET", mode: "cors", credentials: "omit" })
      .then(function (x) { return x.json(); })
      .then(function (cfg) {
        if (cfg && cfg.tenantId) {
          s = {
            tenantId: cfg.tenantId,
            tenantName: cfg.tenantName || null,
            storeDomain: cfg.storeDomain || window.location.hostname,
            enabledEvents: cfg.enabledEvents || Object.values(e.SUPPORTED_EVENTS)
          };
          try { sessionStorage.setItem(e.TENANT_KEY, JSON.stringify(s)); } catch (ex) { }
        }
      })
      .catch(function () { });
  }

  var m = [];
  var p = null;

  var _did = v(e.DEVICE_ID_COOKIE);
  if (!_did) {
    _did = T();
    K(e.DEVICE_ID_COOKIE, _did, e.COOKIE_MAX_AGE_DAYS);
  }
  var f = _did;

  if (window.addEventListener) {
    window.addEventListener("beforeunload", function () { y(); });
  }
  document.addEventListener("visibilitychange", function () {
    if (document.visibilityState === "hidden") y();
  });

  if (!L()) {
    var E = 0;
    var I = setInterval(function () {
      E++;
      if (L() || E >= e.MAX_POLLS) {
        clearInterval(I);
        if (E >= e.MAX_POLLS) {
          console.warn("[Profiqo] window.IkasEvents " + (e.MAX_POLLS * e.POLL_INTERVAL_MS) + "ms içinde bulunamadı.");
        }
      }
    }, e.POLL_INTERVAL_MS);
  }

  window.__profiqo = {
    version: "2.1.1",
    apiKey: n,
    deviceId: f,
    getCustomer: function () { return l || A(); },
    getTenant: function () { return s; },
    flush: y,
    track: function (type, data) { P({ type: type, data: data }); }
  };

  function T() {
    if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (ch) {
      var rnd = 16 * Math.random() | 0;
      return (ch === "x" ? rnd : (3 & rnd) | 8).toString(16);
    });
  }

  function v(name) {
    var m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
    return m ? decodeURIComponent(m[2]) : null;
  }

  function K(name, value, days) {
    var exp = "";
    if (days) {
      var dt = new Date();
      dt.setTime(dt.getTime() + 24 * days * 60 * 60 * 1e3);
      exp = "; expires=" + dt.toUTCString();
    }
    document.cookie = name + "=" + encodeURIComponent(value) + exp + "; path=/; SameSite=Lax; Secure";
  }

  function S() {
    var now = Date.now();
    var raw = null;

    try { raw = sessionStorage.getItem(e.SESSION_ID_KEY); } catch (ex) { }

    if (raw) {
      try {
        var obj = JSON.parse(raw);
        if (now - obj.ts < e.SESSION_TIMEOUT_MS) {
          obj.ts = now;
          try { sessionStorage.setItem(e.SESSION_ID_KEY, JSON.stringify(obj)); } catch (ex) { }
          return obj.id;
        }
      } catch (ex) { }
    }

    var sid = T();
    try { sessionStorage.setItem(e.SESSION_ID_KEY, JSON.stringify({ id: sid, ts: now })); } catch (ex) { }
    return sid;
  }

  function O() {
    return {
      url: window.location.href,
      path: window.location.pathname,
      referrer: document.referrer || null,
      title: document.title || null,
      userAgent: navigator.userAgent,
      language: navigator.language || null,
      screenWidth: window.screen ? window.screen.width : null,
      screenHeight: window.screen ? window.screen.height : null
    };
  }

  function A() {
    if (o && o.ud) {
      var ud = o.ud;
      if (ud.id || ud.em) return { id: ud.id || null, email: ud.em || null, firstName: ud.fn || null, lastName: ud.ln || null, phone: ud.ph || null, isGuest: false };
    }

    if (window.__ikas__ && window.__ikas__.customer) {
      var c = window.__ikas__.customer;
      if (c.id || c.email) return { id: c.id || null, email: c.email || null, firstName: c.firstName || null, lastName: c.lastName || null, phone: c.phone || null, isGuest: false };
    }

    if (window.__NEXT_DATA__ && window.__NEXT_DATA__.props) {
      var pp = window.__NEXT_DATA__.props.pageProps || window.__NEXT_DATA__.props;
      var u = pp.customer || pp.currentCustomer || pp.user;
      if (u && (u.id || u.email)) return { id: u.id || null, email: u.email || null, firstName: u.firstName || null, lastName: u.lastName || null, phone: u.phone || null, isGuest: false };
    }

    var tok = v("ikas_ct") || v("ikas_customer_token");
    if (tok) {
      try {
        var parts = tok.split(".");
        if (parts.length === 3) {
          var payload = JSON.parse(atob(parts[1].replace(/-/g, "+").replace(/_/g, "/")));
          if (payload.sub || payload.customerId || payload.email) {
            return { id: payload.sub || payload.customerId || null, email: payload.email || null, firstName: payload.firstName || null, lastName: payload.lastName || null, phone: null, isGuest: false };
          }
        }
      } catch (ex) { }
    }

    try {
      var cached = sessionStorage.getItem(e.CUSTOMER_KEY);
      if (cached) {
        var cst = JSON.parse(cached);
        if (cst && (cst.id || cst.email || cst.phone)) return cst;
      }
    } catch (ex) { }

    return { id: null, email: null, firstName: null, lastName: null, phone: null, isGuest: true };
  }

  function N(cust) {
    if (!cust || !(cust.id || cust.email || cust.phone)) return;

    var prev = l || {};
    l = {
      id: cust.id || prev.id || null,
      email: cust.email || prev.email || null,
      firstName: cust.firstName || prev.firstName || null,
      lastName: cust.lastName || prev.lastName || null,
      phone: cust.phone || prev.phone || null,
      isGuest: !cust.id && !prev.id
    };

    try { sessionStorage.setItem(e.CUSTOMER_KEY, JSON.stringify(l)); } catch (ex) { }
  }

  function y() {
    if (m.length === 0) return;

    var batch = m.splice(0, e.MAX_QUEUE_SIZE);
    var cust = l || A();

    var payload = JSON.stringify({
      apiKey: n,
      deviceId: f,
      sessionId: S(),
      sentAt: (new Date()).toISOString(),
      customer: cust,
      tenant: s ? { tenantId: s.tenantId, tenantName: s.tenantName, storeDomain: s.storeDomain } : { storeDomain: window.location.hostname },
      events: batch
    });

    h(payload, 0);
  }

  function h(body, attempt) {
    var url = r + e.EVENTS_ENDPOINT;

    if (navigator.sendBeacon && attempt === 0) {
      var blob = new Blob([body], { type: "text/plain" });
      if (navigator.sendBeacon(url, blob)) return;
    }

    if (typeof fetch === "function") {
      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: body,
        keepalive: true,
        mode: "cors",
        credentials: "omit"
      }).catch(function () {
        if (attempt < e.MAX_RETRIES) setTimeout(function () { h(body, attempt + 1); }, e.RETRY_DELAY_MS * Math.pow(2, attempt));
      });
      return;
    }

    try {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.onerror = function () {
        if (attempt < e.MAX_RETRIES) setTimeout(function () { h(body, attempt + 1); }, e.RETRY_DELAY_MS * Math.pow(2, attempt));
      };
      xhr.send(body);
    } catch (ex) { }
  }

  function C(evt) {
    m.push(evt);

    if (m.length >= e.MAX_QUEUE_SIZE) {
      clearTimeout(p);
      p = null;
      y();
      return;
    }

    if (!p) {
      p = setTimeout(function () {
        p = null;
        y();
      }, e.BATCH_INTERVAL_MS);
    }
  }

  function g(item) {
    if (!item) return {};

    if (item.variant && typeof item.variant === "object") {
      var v = item.variant;
      return {
        productId: v.productId || null,
        variantId: v.id || null,
        quantity: item.quantity || item.c || item.q || 1,
        price: item.finalPrice || item.price || item.p || null,
        productName: v.name || null,
        productSlug: v.slug || null,
        brandName: v.brand && v.brand.name ? v.brand.name : null,
        categoryName: v.categories && v.categories.length ? (v.categories[0].name || null) : null
      };
    }

    return {
      productId: item.pid || item.productId || null,
      variantId: item.vid || item.variantId || null,
      quantity: item.c || item.q || item.quantity || 1,
      price: item.p || item.price || item.finalPrice || null
    };
  }

  function D(type, data) {
    switch (type) {
      case "ADD_TO_CART":
      case "REMOVE_FROM_CART":
        return (function (e2) {
          if (!e2) return {};
          var out = {};

          if (e2.crtItm) {
            var n = g(e2.crtItm);
            out.productId = n.productId;
            out.variantId = n.variantId;
            out.quantity = n.quantity;
            out.price = n.price;
          }

          if (e2.crt) {
            var cart = e2.crt;
            out.cartId = cart.id || null;
            out.currency = cart.c || "TRY";
            out.cartTotalPrice = cart.pr || null;
            out.cartItemCount = cart.il ? cart.il.length : null;

            if (cart.il && Array.isArray(cart.il)) {
              out.cartItems = cart.il.map(function (x) { return g(x); });
            }
          }

          return out;
        })(data);

      case "COMPLETE_CHECKOUT":
        return (function (e2) {
          if (!e2) return {};
          var ord = e2.ord || e2.order || e2.checkout || e2.crt || e2.cart || e2;
          var out = {};
          out.orderId = ord.id || ord.oid || ord.orderId || null;
          out.orderNumber = ord.on || ord.orderNumber || ord.number || null;
          out.totalPrice = ord.pr || ord.tp || ord.totalFinalPrice || ord.totalPrice || ord.total || null;
          out.currency = ord.c || ord.currencyCode || ord.currency || "TRY";

          var items = ord.il || ord.items || ord.orderLineItems || ord.lines;
          if (items && Array.isArray(items)) {
            out.itemCount = items.length;
            out.items = items.map(function (x) { return g(x); });
          }
          return out;
        })(data);

      case "ADD_TO_WISHLIST":
        return (function (e2) {
          if (!e2) return {};
          var pr = e2.pr || e2.prd || e2;
          return { productId: pr.id || pr.pid || null, variantId: pr.vid || null };
        })(data);

      default:
        return data || {};
    }
  }

  function R(code) {
    var t2 = e.IKAS_EVENT_TYPES[code];
    if (t2 && ["ADD_TO_CART", "REMOVE_FROM_CART", "COMPLETE_CHECKOUT", "ADD_TO_WISHLIST"].indexOf(t2) !== -1) return t2;
    return null;
  }

  function w(type) {
    if (!type) return null;

    if (typeof type === "number") return R(type);

    var key = String(type).toLowerCase().replace(/[_\-\s]/g, "");
    var mapped = e.IKAS_STRING_EVENTS[key];
    if (mapped) return mapped;

    var up = String(type).toUpperCase().replace(/[_\-\s]/g, "");
    return e.SUPPORTED_EVENTS[up] || null;
  }

  function M(type) {
    return !s || !s.enabledEvents || s.enabledEvents.indexOf(type) !== -1;
  }

  function extractCustomerFromEvent(x) {
    if (!x) return null;

    var cust = null;
    var phone = null, fn = null, ln = null;

    if (x.cart && x.cart.customer) cust = x.cart.customer;
    else if (x.order && x.order.customer) cust = x.order.customer;
    else if (x.customer && (x.customer.id || x.customer.email)) cust = x.customer;

    var addr = null;
    if (x.cart && x.cart.shippingAddress) addr = x.cart.shippingAddress;
    else if (x.order && x.order.shippingAddress) addr = x.order.shippingAddress;
    else if (x.shippingAddress) addr = x.shippingAddress;

    if (addr) {
      phone = addr.phone || null;
      fn = addr.firstName || null;
      ln = addr.lastName || null;
    }

    var fallbackCustomerId = null;
    if (x.cart && x.cart.customerId) fallbackCustomerId = x.cart.customerId;

    if (cust && (cust.id || cust.email)) {
      return {
        id: cust.id || fallbackCustomerId || null,
        email: cust.email || null,
        firstName: cust.firstName || fn || null,
        lastName: cust.lastName || ln || null,
        phone: cust.phone || phone || null,
        isGuest: cust.isGuestCheckout === true
      };
    }

    if (fallbackCustomerId) {
      return { id: fallbackCustomerId, email: null, firstName: fn || null, lastName: ln || null, phone: phone || null, isGuest: false };
    }

    if (phone) {
      return { id: null, email: null, firstName: fn || null, lastName: ln || null, phone: phone, isGuest: true };
    }

    return null;
  }

  function mapCartLike(i) {
    if (!i) return {};
    var out = {};

    var item = i.item;
    if (item) {
      out.quantity = i.quantity || item.quantity || 1;
      out.price = item.finalPrice || item.price || null;
      out.currency = item.currencyCode || "TRY";

      if (item.variant) {
        out.productId = item.variant.productId || null;
        out.variantId = item.variant.id || null;
        out.productName = item.variant.name || null;
        out.productSlug = item.variant.slug || null;
        if (item.variant.brand) out.brandName = item.variant.brand.name || null;
        if (item.variant.categories && item.variant.categories.length) out.categoryName = item.variant.categories[0].name || null;
      }
    }

    var cart = i.cart;
    if (cart) {
      out.cartId = cart.id || null;
      out.currency = cart.currencyCode || out.currency || "TRY";
      out.cartTotalPrice = cart.totalFinalPrice || cart.totalPrice || null;

      var lines = cart.orderLineItems;
      if (lines && Array.isArray(lines)) {
        out.cartItemCount = lines.length;
        out.cartItems = lines.map(function (x) {
          return {
            productId: x.variant ? x.variant.productId : null,
            variantId: x.variant ? x.variant.id : null,
            quantity: x.quantity || 1,
            price: x.finalPrice || x.price || null,
            productName: x.variant ? x.variant.name : null
          };
        });
      }
    }

    return out;
  }

  function mapCompleteCheckout(i) {
    if (!i) return {};
    var src = i.order || i.ord || i.checkout || i.cart || i;
    var out = {};
    out.orderId = src.id || src.oid || src.orderId || null;
    out.orderNumber = src.orderNumber || src.on || src.number || null;
    out.totalPrice = src.totalFinalPrice || src.totalPrice || src.pr || src.tp || src.total || null;
    out.currency = src.currencyCode || src.c || src.currency || "TRY";

    var lines = src.orderLineItems || src.items || src.il || src.lines;
    if (lines && Array.isArray(lines)) {
      out.itemCount = lines.length;
      out.items = lines.map(function (x) {
        return {
          productId: x.variant ? x.variant.productId : (x.productId || null),
          variantId: x.variant ? x.variant.id : (x.variantId || null),
          quantity: x.quantity || 1,
          price: x.finalPrice || x.price || null,
          productName: x.variant ? x.variant.name : (x.productName || null)
        };
      });
    }
    return out;
  }

  function mapWishlist(i) {
    if (!i) return {};
    return {
      productId: i.productId || (i.product ? i.product.id : null) || null,
      variantId: i.variantId || null
    };
  }

  function P(evt) {
    try {
      if (!evt) return;

      var isBundle = evt.e && Array.isArray(evt.e);
      var isType = (typeof evt.type === "string" || typeof evt.type === "number");

      if (isType && evt.data && typeof evt.data === "object" && !isBundle) {
        var mappedType = w(evt.type);
        if (!mappedType || !M(mappedType)) return;

        var i = evt.data;
        var cust2 = extractCustomerFromEvent(i);
        if (cust2) N(cust2);

        var payload = null;
        switch (mappedType) {
          case "ADD_TO_CART":
          case "REMOVE_FROM_CART":
            payload = mapCartLike(i);
            break;
          case "COMPLETE_CHECKOUT":
            payload = mapCompleteCheckout(i);
            break;
          case "ADD_TO_WISHLIST":
            payload = mapWishlist(i);
            break;
          default:
            payload = i || {};
            break;
        }

        C({ eventId: T(), type: mappedType, occurredAt: (new Date()).toISOString(), data: payload, page: O(), customer: l || A() });
        return;
      }

      if (isType && !isBundle) {
        var mappedType2 = w(evt.type);
        if (!mappedType2 || !M(mappedType2)) return;
        C({ eventId: T(), type: mappedType2, occurredAt: (new Date()).toISOString(), data: evt.data || {}, page: O(), customer: l || A() });
        return;
      }

      if (!isBundle) return;

      o = evt;

      if (evt.ud && (evt.ud.id || evt.ud.em)) {
        N({ id: evt.ud.id || null, email: evt.ud.em || null, firstName: evt.ud.fn || null, lastName: evt.ud.ln || null, phone: evt.ud.ph || null, isGuest: false });
      }

      var baseCustomer = l || A();

      evt.e.forEach(function (x) {
        var t2 = R(x.t);
        if (!t2 || !M(t2)) return;

        var a2 = (x.d && typeof x.d === "object")
          ? (x.d.d && typeof x.d.d === "object" ? x.d.d : x.d)
          : {};

        var mapped = D(t2, a2);
        var page = O();

        if (x.d) {
          if (x.d.u) page.url = x.d.u;
          if (x.d.r) page.referrer = x.d.r;
        }

        C({
          eventId: x.id || T(),
          type: t2,
          occurredAt: x.ts ? new Date(x.ts).toISOString() : (new Date()).toISOString(),
          data: mapped,
          page: page,
          customer: baseCustomer
        });
      });
    } catch (ex) { }
  }

  function L() {
    if (typeof window.IkasEvents === "undefined") return false;
    if (typeof window.IkasEvents.subscribe !== "function") return false;

    window.IkasEvents.subscribe({ id: e.SUBSCRIBE_ID, callback: P });
    return true;
  }

}();
